#!/bin/sh

set -x

#you must have a GITHUBTEACHER_TOKEN
#saved to your ENV variables in order to use this script

function getpages () {
  numPages=$((curl -sI -H "Authorization: token $GITHUBTEACHER_TOKEN" -X GET https://api.github.com/orgs/githubschool/repos | grep "^Link:") | (sed -n 's/.*\([0-9]\)>; rel=\"last\".*/\1/p'))
  if [ -z "$numPages"]
    then
      numPages=1
      echo "There is only $numPages page"
    else
      echo "There are $numPages pages"
  fi
  COUNTER=1
  while [ $COUNTER -le $numPages ]; do
    echo "Getting results for page $COUNTER"
    getrepos $COUNTER
    let COUNTER=COUNTER+1
  done
}

#get repos in githubschool org that start with conflict-practice or github-games
function getrepos () {
  pagenum=$1
  repolist=$(curl -H "Authorization: token $GITHUBTEACHER_TOKEN" -X GET https://api.github.com/orgs/githubschool/repos?page=$pagenum | jq '.[] | .name')
  for i in ${repolist[@]}
  do
    i=$(echo "$i" | (sed -e 's/^"//' -e 's/"$//'))
    if echo "$i" | grep -iq -e "conflict-practice-" -e "github-games-"
    then
      echo "Let's see when $i was created"
      checkdates $i
    fi
  done
}

function checkdates () {
  reponame=$1
  created=$((curl -H "Authorization: token $GITHUBTEACHER_TOKEN" -X GET https://api.github.com/repos/githubschool/$reponame | jq .created_at) | (sed -e 's/^"//' -e 's/Z"$//'))
  #if they were created more than 10 days ago, expire them
  if [[ "$compDate" > "$created" ]];
  then
    echo "EXPIRED: $reponame was created on $created"
    benice $reponame
  else
    echo "KEEP: $reponame was created on $created"
  fi
}

function benice () {
  reponame=$1
  user=$(echo "$reponame" | (sed -n -e 's/.*-//p'))
  if echo "$reponame" | grep -iq -e "github-games-"
  then
    template="github-games [here](https://github.com/githubtraining/github-games)"
  else
    template="polygons (our conflict practice activity) [here](https://github.com/githubtraining/polygons)"
  fi
  curl -i -H "Authorization: token $GITHUBTEACHER_TOKEN" -d "{ \"title\": \"Thank you for attending GitHub Training\", \"body\": \"@$user We hope you enjoyed the :octocat: class and we look forward to seeing you in another [class or webinar](https://services.github.com/training/#public) soon. To keep things tidy in the githubschool organization, we are going to remove your practice repository.\n\nIf you would like to revisit these activities in the future, you can access the template repository for $template.\n\nStop by and see us sometime at [services.github.com](https://services.github.com). :wave: Until we see you again, good luck in your GitHub adventures :rocket:.\"}" -X POST https://api.github.com/repos/githubschool/$reponame/issues
  #delete the repo
  script/remove-repo $reponame
}

compDate=$(date -v-10d +%Y-%m-%dT%H:%M:%S)
getpages
